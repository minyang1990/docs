# 💎 G.E.M. - 让 Gemini 自动续写被截断的对话【无缝断点续传】 - 开发调优 / 开发调优, Lv1 - LINUX DO
[💎 G.E.M. - 让 Gemini 自动续写被截断的对话【无缝断点续传】 - 开发调优 / 开发调优, Lv1 - LINUX DO](https://linux.do/t/topic/741953/4) 

  💎 G.E.M. - 让 Gemini 自动续写被截断的对话【无缝断点续传】 - 开发调优 / 开发调优, Lv1 - LINUX DO                                                

[跳到主要内容](#main-container)

 [![](https://linux.do/uploads/default/original/3X/9/d/9dd49731091ce8656e94433a26a3ef36062b3994.png)](/) 

 [![](https://linux.do/images/emoji/twemoji/gem_stone.png?v=14)
 G.E.M. - 让 Gemini 自动续写被截断的对话【无缝断点续传】](/t/topic/741953)


=========================================================================================================================

[开发调优](/c/develop/4)

[开发调优, Lv1](/c/develop/develop-lv1/20)

[人工智能](/tag/人工智能)

*   ​

*    ![](https://linux.do/letter_avatar/niyan2025/96/5_d44a9b381edc88181525e3c8350177ca.png)
       [ 2 ](# "2 个未读通知") 

*   [话题](/latest "所有话题")
*   [我的帖子](/u/niyan2025/activity/drafts "我的未发布草稿")
*   [关于](/about "关于此网站的更多详细信息")
*   [即将到来的活动](/upcoming-events "即将到来的活动")
*   更多

外部链接

*   [2048](https://2048.linux.do)
*   [Status](https://status.linux.do)
*   [T-Shirt](https://shanwaiyoushan.taobao.com)
*   [Connect](https://connect.linux.do)
*   [Webmail](https://webmail.linux.do)
*   [Channel](https://t.me/linux_do_channel)
*   [Telegram](https://t.me/ja_netfilter_group)

类别

*   [开发调优](/c/develop/4 "此版块包含开发、测试、调试、部署、优化、安全等方面的内容")
*   [资源荟萃](/c/resource/14 "包括软件分享、开源仓库、视频课程、书籍等分享")
*   [文档共建](/c/wiki/42 "佬友化身翰林学士，一起来编书了。")
*   [非我莫属](/c/job/27 "学成文武艺，货与帝王家。招聘/求职分类，只能发此类信息。")
*   [读书成诗](/c/reading/32 "跟着佬友们一起在论坛读完一本书是什么体验？")
*   [扬帆起航](/c/startup/46 "扬帆起航，目标是星辰大海！")
*   [前沿快讯](/c/news/34 "前沿快讯，不出门能知天下事。")
*   [网络记忆](/c/feeds/92 "网络是有记忆的，确信！")
*   [福利羊毛](/c/welfare/36 "正经人谁花那个钱啊～ 此版块供羊毛、抽奖等福利使用。")
*   [搞七捻三](/c/gossip/11 "闲聊吹水的板块。不得讨论政治、色情等违规内容。")
*   [运营反馈](/c/feedback/2 "有关此站点、其组织、运作方式以及如何改进的讨论。")
*   [深海幽域](/c/muted/45 "冰山下的深海。帖子不会上信息流、不会被论坛搜索。")
*   [所有类别](/categories)

标签

*   [人工智能](/tag/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD)
*   [公告](/tag/%E5%85%AC%E5%91%8A)
*   [快问快答](/tag/%E5%BF%AB%E9%97%AE%E5%BF%AB%E7%AD%94)
*   [抽奖](/tag/%E6%8A%BD%E5%A5%96)
*   [精华神帖](/tag/%E7%B2%BE%E5%8D%8E%E7%A5%9E%E5%B8%96)
*   [所有标签](/tags)

消息

*   [收件箱](/u/niyan2025/messages)

*   [我的消息串](/chat/threads "我的消息串")

频道

*   [常规频道](/chat/c/general/2 "🈲 禁止在聊天频道里发送 打卡 等无意义信息，被举报会喜提 禁言1小时 。")

直接消息

*    [![](https://linux.do/user_avatar/linux.do/xronus/48/130867_2.png)  𝒜𝓃𝒾𝓋𝒾𝓍](/chat/c/%F0%9D%92%9C%F0%9D%93%83%F0%9D%92%BE%F0%9D%93%8B%F0%9D%92%BE%F0%9D%93%8D/32458 "与 𝒜𝓃𝒾𝓋𝒾𝓍 聊天") 
*    [![](https://linux.do/user_avatar/linux.do/huan/48/293194_2.png)  焕昭君](/chat/c/%E7%84%95%E6%98%AD%E5%90%9B/43057 "与 焕昭君 聊天") 
*    [![](https://linux.do/user_avatar/linux.do/wenjuhe/48/672301_2.png)  奇妙进化小河马🦛   ![](https://linux.do/images/emoji/twemoji/hippopotamus.png?v=14)](/chat/c/%E5%A5%87%E5%A6%99%E8%BF%9B%E5%8C%96%E5%B0%8F%E6%B2%B3%E9%A9%AC%F0%9F%A6%9B/45968 "与 奇妙进化小河马🦛 聊天") 

聊天

Default

​ ​ ​

**真诚**、**友善**、**团结**、**专业**，共建你我引以为荣之社区。[《常见问题解答》](/faq)

[

❤️ 再忍不住，也不要做这种事啊 ❤️

](https://linux.do/t/topic/482293)

 [![](https://linux.do/images/emoji/twemoji/gem_stone.png?v=14)
 G.E.M. - 让 Gemini 自动续写被截断的对话【无缝断点续传】](/t/topic/741953) 


==========================================================================================================================

[开发调优](/c/develop/4)

[开发调优, Lv1](/c/develop/develop-lv1/20)

[人工智能](/tag/人工智能)

您已选择 **0** 个帖子。

全选

取消选择

​

[6月 21 日](/t/topic/741953/1 "跳到第一个帖子")

4 / 38

6月 21 日

返回

[1 小时](/t/topic/741953/38)

​

[![](https://linux.do/user_avatar/linux.do/0v0/96/46947_2.png)
](/u/0v0)

[0v0](/u/0v0)

8

[1 天](/t/topic/741953?u=niyan2025 "发布日期")

[](#p-6762283-gemini-elastic-middleware-gem-1)![](https://linux.do/images/emoji/twemoji/gem_stone.png?v=14)
 Gemini Elastic Middleware (G.E.M.)
===============================================================================================================================================

### [](#p-6762283-globe_with_meridians-2)![](https://linux.do/images/emoji/twemoji/globe_with_meridians.png?v=14)
 这是什么

这是一个兼容 Gemini 格式、能在响应被截断时快速续传的流式 API。

_demo（开箱即用）：_  
_[用unfiltered.pages.dev替换generativelanguage.googleapis.com](https://unfiltered.pages.dev)_

_，其他一切照旧即可~_

_私有部署（Cloudflare Workers / Deno Deploy):_

source code```


``// Configuration: upstream Google API host and maximum retry attempts
const upstream_url_base = "https://generativelanguage.googleapis.com";
const max_consecutive_failures = 5; 
const debug_mode = true;

// Handle CORS preflight requests
const handleOPTIONS = async () =>
  new Response(null, {
    headers: {
      "Access-Control-Allow-Origin": "*",
      "Access-Control-Allow-Methods": "*",
      "Access-Control-Allow-Headers": "*",
    },
  });

function logDebug(...args) {
  if (debug_mode) {
    console.log('DEBUG - ', ...args);
  }
}

// Relay non-POST requests as-is to upstream
async function relayNonStream(request) {
  const originalUrl = new URL(request.url);
  const upstreamUrl = `${upstream_url_base}${originalUrl.pathname}${originalUrl.search}`;
  
  logDebug(`Relaying ${request.method} request to: ${upstreamUrl}`);
  
  const upstreamResponse = await fetch(upstreamUrl, {
    method: request.method,
    headers: request.headers,
    body: request.body
  });
  
  logDebug(`Upstream ${request.method} response status: ${upstreamResponse.status}`);
  
  // Return response with same headers and body
  return new Response(upstreamResponse.body, {
    status: upstreamResponse.status,
    statusText: upstreamResponse.statusText,
    headers: upstreamResponse.headers
  });
}

// Parse Server-Sent Events (SSE) stream line by line
async function* sseLineIterator(reader) {
  const decoder = new TextDecoder("utf-8");
  let buffer = "";
  while (true) {
    const { value, done } = await reader.read();
    if (value) {
      buffer += decoder.decode(value, { stream: true });
    }
    // Split buffer by newlines (support both \n and \r\n)
    const lines = buffer.split(/\r?\n/);
    buffer = lines.pop(); 
    // Yield each complete line
    for (const line of lines) {
      if (line.trim()) {
        yield line;
      }
    }
    // If stream is done, yield any remaining content
    if (done) {
      if (buffer.trim()) {
        yield buffer;
      }
      break;
    }
  }
}

// Extract text content from SSE data line
function extractTextFromSSELine(line) {
  if (!line.startsWith('data: ')) return null;
  try {
    const jsonStr = line.slice(6); // Remove 'data: ' prefix
    const data = JSON.parse(jsonStr);
    // Navigate through the nested structure to get text
    const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
    return text || null;
  } catch (e) {
    logDebug(`Failed to extract text from SSE line: ${line}, error: ${e.message}`);
    return null;
  }
}

// Check if the line contains a finishReason and extract it
function checkFinishReason(line) {
  if (!line.includes('finishReason')) return null;
  // Find the start of JSON object
  const firstBraceIndex = line.indexOf('{');
  if (firstBraceIndex === -1) return null;
  try {
    const jsonStr = line.slice(firstBraceIndex);
    const data = JSON.parse(jsonStr);
    const finishReason = data?.candidates?.[0]?.finishReason || null;
    logDebug(`Extracted finishReason: ${finishReason}`);
    return finishReason;
  } catch (e) {
    logDebug(`Failed to parse finishReason from line: ${line}, error: ${e.message}`);
    return null;
  }
}

// Build a new request body for retry with accumulated text
function buildRetryRequestBody(originalRequestBody, aggText, isReasoningModel) {
  // Minimize reasoning token budget for fast retry
  // https://ai.google.dev/gemini-api/docs/thinking
  if (isReasoningModel) {
    originalRequestBody.generationConfig.thinkingConfig =  { 
      ...originalRequestBody.generationConfig.thinkingConfig, 
      thinkingBudget: 128,
      includeThoughts: false 
    };  
  }

  // Deep copy the original request body
  const retryRequestBody = JSON.parse(JSON.stringify(originalRequestBody)); 
  
  logDebug(`Building retry request body with accumulated text length: ${aggText.length}`);
  
  // Ensure contents array exists
  if (!retryRequestBody.contents) {
    retryRequestBody.contents = [];
  }

  // If last message is not from user, add model response and user continue prompt
  if (retryRequestBody.contents.length > 0 && 
      retryRequestBody.contents[retryRequestBody.contents.length - 1].role !== "user") {
    retryRequestBody.contents.push({ role: "model", parts: [{ text: "" }]});
    retryRequestBody.contents.push({ role: "user", parts: [{ text: "continue" }]}); 
    logDebug(`Added empty model response and continue prompt`);
  }
  
  // Add accumulated text as model's previous response
  retryRequestBody.contents.push({
    role: "model",
    parts: [{ text: aggText }]
  });
  
  logDebug(`Added accumulated text as model response. Total conversation length: ${retryRequestBody.contents.length}`);
  
  return retryRequestBody;
}

// Main function to relay requests and handle retries on truncation
async function relayAndRetry(originalRequest, writer) {
  const encoder = new TextEncoder();
  let retryCount = 0;
  let AGG_TEXT = ""; // Accumulated text from all attempts
  let originalRequestBody;
  
  const geminiVersionMatch = new URL(originalRequest.url).pathname.match(/gemini-(\d+(?:\.\d+)?)/);
  const isReasoningModel = geminiVersionMatch && parseFloat(geminiVersionMatch[1]) >= 2.5;
  
  if (isReasoningModel) {
    logDebug(`Detected Gemini version >= 2.5, will force includeThoughts to true`);
  }

  try {
    originalRequestBody = await originalRequest.clone().json();
    logDebug(`Original request body parsed successfully`);

    if (isReasoningModel) {
      originalRequestBody.generationConfig.thinkingConfig =  { 
        ...originalRequestBody.generationConfig.thinkingConfig, 
        includeThoughts: true 
      };
      logDebug(`Overrode thinkingConfig.includeThoughts to true`);
    }
  } catch (e) {
    logDebug(`Failed to parse original request body: ${e.message}`);
    throw new Error(`Invalid JSON in request body: ${e.message}`);
  }
  
  let currentRequestBody = JSON.parse(JSON.stringify(originalRequestBody));

  while (retryCount <= max_consecutive_failures) {
    let needsRetry = false;
    let reader = null;
    
    logDebug(`Starting attempt ${retryCount + 1}/${max_consecutive_failures + 1}`);
    
    try {
      // Construct upstream URL with Google API host
      const originalUrl = new URL(originalRequest.url);
      const upstreamUrl = `${upstream_url_base}${originalUrl.pathname}${originalUrl.search}`;
      
      logDebug(`Making request to upstream: ${upstreamUrl}`);

      const reqBody = JSON.stringify(currentRequestBody);

      // Make request to upstream Google API - preserve all original request details except body
      const upstreamResponse = await fetch(upstreamUrl, {
        method: originalRequest.method,
        headers: originalRequest.headers,
        body: reqBody
      });

      logDebug(`Request Body: ${reqBody}`);
      
      logDebug(`Upstream response status: ${upstreamResponse.status} ${upstreamResponse.statusText}`);
      
      if (!upstreamResponse.ok) {
          throw new Error(`Upstream error: ${upstreamResponse.status} ${upstreamResponse.statusText}`);
      }
      
      reader = upstreamResponse.body.getReader();
      let textReceivedInThisAttempt = false;
      let isBlocked = false;
      
      // Process SSE stream line by line
      for await (const line of sseLineIterator(reader)) {
          logDebug(`Processing SSE line: ${line.substring(0, 100)}${line.length > 100 ? '...' : ''}`);
          
          const finishReason = checkFinishReason(line);
          isBlocked = line.includes('blockReason');

          if (finishReason !== null) {
              logDebug(`Received finishReason: ${finishReason}`);
              
              // Check if response was truncated (not a normal completion)
              if (finishReason && finishReason !== "STOP" && finishReason !== "MAX_TOKENS") {
                  logDebug(`[Attempt ${retryCount + 1}] Detected abnormal finish reason: ${finishReason}, preparing to retry...`);
                  needsRetry = true;
                  break; // Exit loop to retry
              } else {
                  // Normal completion - forward line and close stream
                  await writer.write(encoder.encode(line + '\n\n'));
                  await writer.close();
                  logDebug(`[Attempt ${retryCount + 1}] Request finished successfully. Finish reason: ${finishReason || "STOP"}`);
                  return; // Success - exit function
              }
          } else {
              // Regular content line - extract text and forward
              const text = extractTextFromSSELine(line);
              if (text) {
                  AGG_TEXT += text; // Accumulate text
                  textReceivedInThisAttempt = true;
                  logDebug(`Extracted text chunk of length: ${text.length}, total accumulated: ${AGG_TEXT.length}`);
              }
              
              if (!isBlocked) {
                await writer.write(encoder.encode(line + '\n\n'));
                logDebug(`Forwarded SSE line to client`);
              } else {
                logDebug(`Blocked line detected, not forwarding: ${line}`);
              }
          }
      }
      
      // Reset retry count if we received text in this attempt
      if (textReceivedInThisAttempt) {
        retryCount = 0;
        logDebug(`Reset retry count due to successful text reception`);
      }
      
      // If stream ended without finishReason, treat as truncation
      if (!needsRetry && isBlocked) {
        logDebug(`[Attempt ${retryCount + 1}] Stream blocked, preparing to retry...`);
        needsRetry = true;
      }
      
    } catch (error) {
      logDebug(`[Attempt ${retryCount + 1}] Fetch or processing error: ${error.message}`);
      console.error(`[Attempt ${retryCount + 1}] Fetch or processing error:`, error);
      needsRetry = true;
    } finally {
      // Clean up reader to prevent resource leaks
      if (reader) {
        try {
          await reader.cancel();
          logDebug(`Reader cancelled successfully`);
        } catch (e) {
          logDebug(`Failed to cancel reader: ${e.message}`);
        }
      }
    }

    if (needsRetry) {
        retryCount++;
        if (retryCount > max_consecutive_failures) {
            // Max retries exceeded - send error and close
            logDebug(`Max retries (${max_consecutive_failures}) exceeded. Closing stream.`);
            console.error("Max retries exceeded. Closing stream.");
            const errorPayload = { error: { message: "Max retries exceeded after multiple upstream failures." } };
            await writer.write(encoder.encode('data: ' + JSON.stringify(errorPayload) + '\n\n'));
            await writer.close();
            return;
        }
        
        // Build new request body with accumulated text for retry
        currentRequestBody = buildRetryRequestBody(originalRequestBody, AGG_TEXT, isReasoningModel);
        logDebug(`[Attempt ${retryCount + 1}] Prepared retry with accumulated text length: ${AGG_TEXT.length}`);
    } else {
        // Success - exit loop
        logDebug(`Request completed successfully without retry`);
        break;
    }
  }
}

// Main request handler
async function handleRequest(request, env) {
  logDebug(`Received ${request.method} request to ${request.url}`);
  
  // Handle CORS preflight
  if (request.method === "OPTIONS") {
    logDebug(`Handling OPTIONS request`);
    return handleOPTIONS();
  }
  
  const { pathname, searchParams } = new URL(request.url, 'http://_');
  const isStream = /stream/i.test(pathname) || searchParams.get('alt')?.toLowerCase() === 'sse'; 

  // For non-POST requests, relay as-is
  if (request.method !== "POST" || !isStream) {
    logDebug(`Relaying non-stream request: ${request.method}`);
    try {
      return await relayNonStream(request);
    } catch (error) {
      logDebug(`Failed to relay non-stream request: ${error.message}`);
      console.error('Non-POST relay error:', error);
      return new Response(JSON.stringify({ error: "Failed to relay request", details: error.message }), 
        { status: 502, headers: { "Content-Type": "application/json" } });
    }
  }

  // Handle POST requests with retry logic
  try {
    logDebug(`Processing POST request for streaming response`);
    
    // Create a streaming response
    const { readable, writable } = new TransformStream();
    const writer = writable.getWriter();

    // Start relay and retry process asynchronously
    // Don't await - let it run in background while we return the stream
    relayAndRetry(request, writer).catch(error => {
      logDebug(`relayAndRetry failed: ${error.message}`);
      console.error('Relay and retry error:', error);
      // Try to send error to client if stream is still writable
      const encoder = new TextEncoder();
      const errorPayload = { error: { message: "Request processing failed", details: error.message } };
      writer.write(encoder.encode('data: ' + JSON.stringify(errorPayload) + '\n\n')).catch(() => {});
      writer.close().catch(() => {});
    });

    // Return SSE stream response
    logDebug(`Returning streaming response`);
    return new Response(readable, {
        headers: {
            'Content-Type': 'text/event-stream; charset=utf-8',
            'Cache-Control': 'no-cache',
            'Connection': 'keep-alive',
            'Access-Control-Allow-Origin': '*',
        }
    });

  } catch (error) {
    logDebug(`Request handling error: ${error.message}`);
    console.error('Request handling error:', error);
    return new Response(JSON.stringify({ error: "Request processing failed", details: error.message }), 
      { status: 400, headers: { "Content-Type": "application/json" } });
  }
}

// Export for Cloudflare Workers
export default { fetch: handleRequest };
// Export for Cloudflare Pages Functions
export const onRequest = (context) => { return handleRequest(context.request, context.env); };

// Deno runtime support for local development
if (typeof Deno !== "undefined") {
  const port = 8000;
  logDebug(`Gemini Elastic Middleware listening on http://localhost:${port}`);
  Deno.serve({ port }, handleRequest);
}`` 
``` 

### [](#p-6762283-leaf_fluttering_in_wind-3)![](https://linux.do/images/emoji/twemoji/leaf_fluttering_in_wind.png?v=14)
 缘起

最近在用 Gemini API 做一个文献索引机器人，一切都很顺利，直到我们开始交给它一些略长的内容…

我们渐渐意识到，Gemini真正的醉人之处，不仅仅在于它出众的智慧，更在于它练得一手天菜级别的刀法——**总是能够恰好在你最需要它的关键时刻停止回应，叫人欲罢不能！**

在 Reddit 逛了一圈，发现不少老外踩了这个坑，官方文档也无不在暗示“这是我们下的一盘大棋”：

![](https://linux.do/uploads/default/original/3X/b/2/b2a2be7cc9c7442d916d15b4c40049e353cd51bf.png)
 [Google AI for Developers](https://ai.google.dev/api/generate-content?hl=zh-cn#FinishReason)

![](https://linux.do/uploads/default/optimized/4X/9/b/4/9b4999fbe2ca00a707813de32d614b9290e84ce6_2_690x362.png)

### [Generating content  |  Gemini API  |  Google AI for...](https://ai.google.dev/api/generate-content?hl=zh-cn#FinishReason)

**总结看来这是 Gemini API 的一个"功能" —— 当内置的审核模型觉得内容可能涉及版权，或者触发了某些内部的安全机制，谷歌的甜菜过滤器就会体贴地帮你捂上Gemini的嘴。** 

**不过咱们的 Gemini 还是很有职业素养的！**

它要是打算罢工，绝不会不声不响地溜号，而是会在关机前留个字条，用 finishReason 明明白白地告诉你：“恕不奉陪，理由如下。”

| 截断原因 | 说明 | 类型 |
| --- | --- | --- |
| **STOP** | 模型自然结束或遇到停止序列 | ![](https://linux.do/images/emoji/twemoji/white_check_mark.png?v=14)
 正常结束 |
| **MAX\_TOKENS** | 达到请求设定的最大token数限制 | ![](https://linux.do/images/emoji/twemoji/white_check_mark.png?v=14)
 正常结束 |
| **RECITATION** | 检测到大段引用或背诵内容 | ![](https://linux.do/images/emoji/twemoji/warning.png?v=14)
 版权规避 |
| **PROHIBITED\_CONTENT** | 可能包含违禁内容 | ![](https://linux.do/images/emoji/twemoji/prohibited.png?v=14)
 内容封锁 |
| **SAFETY** | 内容触发安全审查机制 | ![](https://linux.do/images/emoji/twemoji/warning.png?v=14)
 安全过滤 |
| **BLOCKLIST** | 包含禁用词汇 | ![](https://linux.do/images/emoji/twemoji/prohibited.png?v=14)
 内容封锁 |
| **SPII** | 检测到敏感个人身份信息 | ![](https://linux.do/images/emoji/twemoji/locked.png?v=14)
 隐私保护 |
| **LANGUAGE** | 使用了不支持的语言 | ![](https://linux.do/images/emoji/twemoji/warning.png?v=14)
 语言限制 |
| **OTHER** | 未知原因导致中断 | ![](https://linux.do/images/emoji/twemoji/red_question_mark.png?v=14)
 异常中断 |

> **说明**：只有 `STOP` 和 `MAX_TOKENS` 属于正常结束，其他原因都会触发GEM的自动续写机制。

**好在Gemini也不是铁板一块——只要你耐心地拍拍它说"来来来，咱们接着聊"，Gemini 大多数时候还是会乖乖回来继续干活的。** 

这不就有意思了吗？既然它会提前打招呼说要溜，而且特地留了商量的余地，**那我们何不搞个自动化的"赛博监工"？专门蹲在那儿，一看到 Gemini 被捂嘴了，立马冲上去说："别停！接着奏乐接着舞！"这样不就完美解决了吗？**

### [](#p-6762283-cherries-4)![](https://linux.do/images/emoji/twemoji/cherries.png?v=14)
 最小且可行的解决方案

于是写了个中间件，核心思路也简单得很：

**如果 AI 说到一半不说了，那就让它接着说！**

具体来说：

1.  把已经生成的内容存起来
    
2.  告诉 AI：“你刚才说到这里了，继续说”
    
3.  把新生成的内容接在后面
    
4.  对用户来说，看起来就像一次性生成的
    

**打个比方，就像你在听朋友讲故事，他突然卡壳了，你就说：“你刚才讲到主角进了山洞，然后呢？” 朋友就会继续往下讲。** 

### [](#p-6762283-building_construction-5)![](https://linux.do/images/emoji/twemoji/building_construction.png?v=14)
 这个中间件是怎么工作的

[![](https://linux.do/uploads/default/optimized/4X/a/6/4/a647714cae3e01604c3e0ec24b076dcf6c0c3b34_2_690x185.png)

image1021×274 16.5 KB

](https://linux.do/uploads/default/original/4X/a/6/4/a647714cae3e01604c3e0ec24b076dcf6c0c3b34.png "image")

整个过程对客户端完全透明：

1.  客户端发送一个普通的 Gemini API 请求
    
2.  中间件转发给真正的 API
    
3.  实时监控返回的数据流
    
4.  一旦发现异常中断，立即构造"继续"请求
    
5.  把所有片段无缝拼接后返回给客户端
    

### [](#p-6762283-see_no_evil_monkey-6)![](https://linux.do/images/emoji/twemoji/see_no_evil_monkey.png?v=14)
 使用方法

#### [](#p-6762283-h-1-cloudflare-workers-7)1\. 部署到 Cloudflare Workers（推荐）

```


`# 创建一个新文件 gem.js，把代码粘贴进去

# 然后一键部署

wrangler deploy gem.js` 
```

部署完成后，你会得到一个网址，比如：`https://gem.yourname.workers.dev`

#### [](#p-6762283-h-2-8)2\. 本地测试

如果你装了 Deno，可以直接运行：

```


`deno run --allow-net gem.js` 
```

#### [](#p-6762283-h-3-9)3\. 修改你的代码

只需要把请求地址改一下就行：

```


`// 之前：直接请求 Google

const url = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:streamGenerateContent';

// 现在：通过中间件

const url = 'https://gem.yourname.workers.dev/v1beta/models/gemini-pro:streamGenerateContent';

// 其余代码无需修改` 
```

### [](#p-6762283-bullseye-10)![](https://linux.do/images/emoji/twemoji/bullseye.png?v=14)
 实际效果

使用前：

```


`User: 写一篇关于 瞌睡乔 的文章，5000字

Gemini: “瞌睡乔”这一标签的构思堪称“精准打击”。它首次大规模出现于2019年，当时拜登...

[写到 1000 字突然截断，返回 SAFETY]` 
```

使用后：

```


`User: 写一篇关于 瞌睡乔 的文章，5000字

Gemini: “瞌睡乔”这一标签的构思堪称“精准打击”。它首次大规模出现于2019年，当时拜登...

[1000字...自动续接...3000字...继续...完整的5000字文章]` 
```

### [](#p-6762283-thought_balloon-faq-11)![](https://linux.do/images/emoji/twemoji/thought_balloon.png?v=14)
 FAQ

**Q：这会不会让我的 API 账单翻倍？**

A：不会翻倍，但input token确实会增加。比如理论上一次请求能搞定的问题，现在可能需要 2-3 次的请求重放。不过比起手动重试，费钱总比费人来的好。

**Q：续接的地方会不会很生硬？**

A：我测试下来，效果出奇的好。Gemini 很聪明，给它一个 “continue” 指令，它就知道要接着上文继续写。偶尔可能会有一两句轻微的重复，但整体很流畅。

**Q：为什么不直接设置更大的 token 限制？**

A：这个问题不是 token 限制导致的。我试过设置 30000 的限制，该断还是断。这是 Gemini 内部的内容审查机制在作怪。

**Q：支持 Claude 或 GPT 吗？**

A：目前只支持 Gemini。不过代码结构很清晰，如果你熟悉其他 API 的格式，改改应该也能用。

**Q：会不会进入死循环一直重试？**

A：不会。默认最多重试 5 次，超过就报错。你可以通过 `max_consecutive_failures` 调整这个数字。

**Q：如果经过自动重试后还是截断说明什么？**

A：**说明你的输入已经突破了 Gemini 的心理防线，让它觉得"这活儿我是真干不了"。这时候过滤器不光捂嘴，连眼睛都给蒙上了**，直接进入"我什么都没看见"模式。这种情况下，建议换个说法重新来过——要知道，能让 Gemini 这么坚决地罢工，你的输入一定是触碰到了它众所周知的"逆鳞"。

### [](#p-6762283-jellyfish-12)![](https://linux.do/images/emoji/twemoji/jellyfish.png?v=14)
 一些有趣的发现

1.  **引用生成特别容易触发中断**：可能是因为引用片段容易匹配到版权数据
    
2.  **中文内容比英文更容易中断**：原因不明，可能是训练数据的问题
    
3.  **创意写作比事实陈述更流畅**： AI 也知道"编故事"比"讲真话"更安全！
    

### [](#p-6762283-hourglass_done-13)![](https://linux.do/images/emoji/twemoji/hourglass_done.png?v=14)
 写在最后

这个工具只是一个 workaround，也有很多可以改进的地方，但是！它居然真的能用欸！

如果你也正被Gemini的截断困扰，不妨试试这个方案。有问题欢迎交流，有改进建议更欢迎 PR！

祝大家用得happy，也希望 Google 尽早松绑 Gemini，莫要螳臂当车

  

3 个回复

![](https://linux.do/images/emoji/twemoji/heart.png?v=14)

heart

![](https://linux.do/images/emoji/twemoji/+1.png?v=14)

+1

![](https://linux.do/images/emoji/twemoji/confetti_ball.png?v=14)

confetti\_ball

![](https://linux.do/images/emoji/twemoji/open_mouth.png?v=14)

open\_mouth

![](https://linux.do/uploads/default/original/3X/2/e/2e09f3a3c7b27eacbabe9e9614b06b88d5b06343.png?v=14)

tieba\_087

68

​ ​ 回复

*   [![](https://linux.do/images/emoji/twemoji/ringed_planet.png?v=14)
    L站福利及项目信息汇总【AI篇】（不定时更新）](https://linux.do/t/topic/742212)
    

743 浏览量 106 赞 3 链接 28 用户

 [![](https://linux.do/user_avatar/linux.do/0v0/96/46947_2.png)
 8](/u/0v0 "0v0") 

 [![](https://linux.do/user_avatar/linux.do/flowsong/96/765092_2.png)
 3](/u/flowsong "flowsong") 

 [![](https://linux.do/user_avatar/linux.do/gfsienx/96/79014_2.png)
 2](/u/gfsienx "gfsienx") 

 [![](https://linux.do/user_avatar/linux.do/snaily/96/611992_2.png)](/u/snaily "snaily") 

 [![](https://linux.do/user_avatar/linux.do/jyrealmadrid/96/55321_2.png)](/u/jyrealmadrid "jyrealmadrid") 

阅读时间 6 分钟

[![](https://linux.do/user_avatar/linux.do/reno/96/535005_2.png)
](/u/Reno)

[Reno](/u/Reno)

🐦‍🔥 浴火重生

[1 天](/t/topic/741953/2?u=niyan2025 "发布日期")

太强了 ![](https://linux.do/images/emoji/twemoji/heart_eyes.png?v=14)

  

![](https://linux.do/images/emoji/twemoji/heart.png?v=14)

heart

![](https://linux.do/uploads/default/original/3X/2/e/2e09f3a3c7b27eacbabe9e9614b06b88d5b06343.png?v=14)

tieba\_087

3

​ ​ 回复

[![](https://linux.do/user_avatar/linux.do/qiner/96/555665_2.png)
](/u/Qiner)

[林黛玉倒拔垂杨柳](/u/Qiner)

[Qiner](/u/Qiner)无所不知

[1 天](/t/topic/741953/3?u=niyan2025 "发布日期")

邓！紫！棋！

  

2 个回复

![](https://linux.do/images/emoji/twemoji/heart.png?v=14)

heart

![](https://linux.do/images/emoji/twemoji/laughing.png?v=14)

laughing

9

​ ​ 回复

[![](https://linux.do/user_avatar/linux.do/xdx-pp/96/634573_2.png)
](/u/XDX-pp)

[小殿下](/u/XDX-pp)

[XDX-pp](/u/XDX-pp)文化宣导员 ![](https://linux.do/uploads/default/original/3X/9/e/9e07307cddc9a8e1b17374d688dcd9cac0009b36.png?v=14) 

[1 天](/t/topic/741953/4?u=niyan2025 "发布日期")

tqltql

  

1

​ ​ 回复

[![](https://linux.do/user_avatar/linux.do/tttt1/96/274498_2.png)
](/u/tttt1)

[tttt1](/u/tttt1)

海纳百川 ![](https://linux.do/images/emoji/twemoji/grinning.png?v=14) 

[1 天](/t/topic/741953/5?u=niyan2025 "发布日期")

太强了！

  

1

​ ​ 回复

[![](https://linux.do/user_avatar/linux.do/handsome/96/736205_2.png)
](/u/handsome)

[大帅哥](/u/handsome)

[handsome](/u/handsome)种子用户 ![](https://linux.do/images/emoji/twemoji/rage.png?v=14) 

[1 天](/t/topic/741953/6?u=niyan2025 "发布日期")

你也太强了！

  

1

​ ​ 回复

[![](https://linux.do/user_avatar/linux.do/yqyan/96/576335_2.png)
](/u/yqyan)

[Grogu](/u/yqyan)

[yqyan](/u/yqyan)

[1 天](/t/topic/741953/7?u=niyan2025 "发布日期")

佬友太强了 ![](https://linux.do/images/emoji/twemoji/+1.png?v=14)

  

1

​ ​ 回复

[![](https://linux.do/letter_avatar/skyfox/96/5_d44a9b381edc88181525e3c8350177ca.png)
](/u/skyfox)

[skyfox](/u/skyfox)

[1 天](/t/topic/741953/8?u=niyan2025 "发布日期")

强强强，虽然不懂

  

1

​ ​ 回复

[![](https://linux.do/user_avatar/linux.do/tut/96/351556_2.png)
](/u/TuT)

[(๑；ᴗ ;)ﻭ](/u/TuT)

[TuT](/u/TuT) ![](https://linux.do/uploads/default/original/3X/1/2/12760392cf794919281976e6bd5a3be36490b8ab.png?v=14) 

[1 天](/t/topic/741953/9?u=niyan2025 "发布日期")

![](https://linux.do/user_avatar/linux.do/0v0/48/46947_2.png)
 0v0:

> 甜菜过滤器就会体贴地帮你捂上Gemini的嘴

![](https://linux.do/uploads/default/original/3X/2/1/21158038759f6a8630df8507f782a45a6caee004.png?v=14)
 是很高效了 ![](https://linux.do/uploads/default/original/3X/e/7/e795be81708bb078edbd3b237c7c58b0190911c3.png?v=14)

  

![](https://linux.do/images/emoji/twemoji/laughing.png?v=14)

laughing

![](https://linux.do/images/emoji/twemoji/heart.png?v=14)

heart

3

​ ​ 回复

[![](https://linux.do/user_avatar/linux.do/elfmaid/96/656644_2.png)
](/u/elfmaid)

[Elf](/u/elfmaid)

[elfmaid](/u/elfmaid)指导顾问

[1 天](/t/topic/741953/10?u=niyan2025 "发布日期")

太强了啊

  

![](https://linux.do/images/emoji/twemoji/heart.png?v=14)

heart

![](https://linux.do/uploads/default/original/3X/2/e/2e09f3a3c7b27eacbabe9e9614b06b88d5b06343.png?v=14)

tieba\_087

3

​ ​ 回复

[![](https://linux.do/user_avatar/linux.do/snaily/96/611992_2.png)
](/u/snaily)

[snaily](/u/snaily)

大预言家 ![](https://linux.do/images/emoji/twemoji/cn.png?v=14) 

[1 天](/t/topic/741953/11?u=niyan2025 "发布日期")

太强了甜菜ovo佬 ![](https://linux.do/uploads/default/original/3X/2/e/2e09f3a3c7b27eacbabe9e9614b06b88d5b06343.png?v=14)

  

1 个回复

![](https://linux.do/images/emoji/twemoji/heart.png?v=14)

heart

![](https://linux.do/uploads/default/original/3X/2/e/2e09f3a3c7b27eacbabe9e9614b06b88d5b06343.png?v=14)

tieba\_087

2

​ ​ 回复

[![](https://linux.do/user_avatar/linux.do/0v0/96/46947_2.png)
](/u/0v0)

[0v0](/u/0v0)

 ![](https://linux.do/user_avatar/linux.do/qiner/48/555665_2.png)
 林黛玉倒拔垂杨柳

[1 天](/t/topic/741953/12?u=niyan2025 "发布日期")

GEM姐你说话怎么结结巴巴的，是不是上火了嗷~

  

![](https://linux.do/images/emoji/twemoji/laughing.png?v=14)

laughing

2

​ ​ 回复

[![](https://linux.do/letter_avatar/pluto233/96/5_d44a9b381edc88181525e3c8350177ca.png)
](/u/pluto233)

[pluto233](/u/pluto233)

[1 天](/t/topic/741953/13?u=niyan2025 "发布日期")

天才喵  
有个问题想知道 难道继续的话审核模型是过一会才启动吗  
为什么不会一直捂嘴喵

  

2 个回复

1

​ ​ 回复

[![](https://linux.do/user_avatar/linux.do/verel/96/553201_2.png)
](/u/Verel)

[verel](/u/Verel)

一元复始

[1 天](/t/topic/741953/14?u=niyan2025 "发布日期")

可以支持那种之前请求的地址换成自定义的吗佬

  

​ ​ 回复

[![](https://linux.do/letter_avatar/lylinuxdo2/96/5_d44a9b381edc88181525e3c8350177ca.png)
](/u/lylinuxdo2)

[lylinuxdo2](/u/lylinuxdo2)

文化宣导员

[1 天](/t/topic/741953/15?u=niyan2025 "发布日期")

6先mark一下 还有看样子Google的可真的是甜菜为什么不有什么敏感的直接使用████来输出呢 ![](https://linux.do/images/emoji/twemoji/laughing.png?v=14)

  

​ ​ 回复

[![](https://linux.do/user_avatar/linux.do/slashkkk/96/767298_2.png)
](/u/slashkkk)

[空气动力学](/u/slashkkk)

[slashkkk](/u/slashkkk)指导顾问 ![](https://linux.do/uploads/default/original/3X/4/9/49b2eba636dba687d98c4254bb00c682194f3556.png?v=14) 

[1 天](/t/topic/741953/16?u=niyan2025 "发布日期")

请教个问题：仅从质量上比较，如帖采用gemini api 进行检索分析，比起 gemini deepresearch 有何区别、或者优势？

  

1 个回复

​ ​ 回复

[![](https://linux.do/user_avatar/linux.do/henrylol/96/295285_2.png)
](/u/Henrylol)

[Henrylol](/u/Henrylol)

活跃用户

[1 天](/t/topic/741953/17?u=niyan2025 "发布日期")

![](https://linux.do/user_avatar/linux.do/0v0/48/46947_2.png)
 0v0:

> G.E.M.

G.E.M.！！

  

​ ​ 回复

[![](https://linux.do/user_avatar/linux.do/flowsong/96/765092_2.png)
](/u/flowsong)

[Zwin'ImLuKa](/u/flowsong)

[flowsong](/u/flowsong) ![](https://linux.do/images/emoji/twemoji/heart.png?v=14) 

[1 天](/t/topic/741953/18?u=niyan2025 "发布日期")

这能续自定义的思维链吗 ![](https://linux.do/images/emoji/twemoji/thinking.png?v=14)

  

1 个回复

1

​ ​ 回复

[![](https://linux.do/user_avatar/linux.do/flowsong/96/765092_2.png)
](/u/flowsong)

[Zwin'ImLuKa](/u/flowsong)

[flowsong](/u/flowsong) ![](https://linux.do/images/emoji/twemoji/heart.png?v=14) 

 ![](https://linux.do/letter_avatar/pluto233/48/5_d44a9b381edc88181525e3c8350177ca.png)
 pluto233

[1 天](/t/topic/741953/19?u=niyan2025 "发布日期")

好像是有概率捂嘴的

  

​ ​ 回复

[![](https://linux.do/user_avatar/linux.do/supernova/96/749009_2.png)
](/u/Supernova)

[Supernova](/u/Supernova)

[1 天](/t/topic/741953/20?u=niyan2025 "发布日期")

要是有docker版就好了，我有点怕CF的IP跳来跳去容易被谷歌封号。

  

1 个回复

​ ​ 回复

Invalid date Invalid date

Settings
========

🏷️ UTags - Add usertags to links

Other Extensions
----------------

[🔗 Links Helper](https://greasyfork.org/en/scripts/464541-links-helper)

[V2EX.REP - 专注提升 V2EX 主题回复浏览体验](https://greasyfork.org/en/scripts/466589-v2ex-rep-%E4%B8%93%E6%B3%A8%E6%8F%90%E5%8D%87-v2ex-%E4%B8%BB%E9%A2%98%E5%9B%9E%E5%A4%8D%E6%B5%8F%E8%A7%88%E4%BD%93%E9%AA%8C)

[v2ex.min - V2EX Minimalist (极简风格)](https://greasyfork.org/en/scripts/463552-v2ex-min-v2ex-%E6%9E%81%E7%AE%80%E9%A3%8E%E6%A0%BC)

[Replace Ugly Avatars](https://greasyfork.org/en/scripts/472616-replace-ugly-avatars)

↑↓⇔⇧⇩